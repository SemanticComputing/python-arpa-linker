<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>arpa API documentation</title>
    <meta name="description" content="A module for linking resources to an RDF graph with an [ARPA](https://github.com/jiemakel/arpa) serv..." />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>

  <style type="text/css">
  .codehilite .hll { background-color: #ffffcc }
.codehilite  { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>

  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">
    <li class="set"><h3><a href="#header-variables">Module variables</a></h3>
      
  <ul>
    <li class="mono"><a href="#arpa.LABEL_PROP">LABEL_PROP</a></li>
    <li class="mono"><a href="#arpa.TYPE_PROP">TYPE_PROP</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#arpa.arpafy">arpafy</a></li>
    <li class="mono"><a href="#arpa.combine_candidates">combine_candidates</a></li>
    <li class="mono"><a href="#arpa.log_to_file">log_to_file</a></li>
    <li class="mono"><a href="#arpa.main">main</a></li>
    <li class="mono"><a href="#arpa.map_results">map_results</a></li>
    <li class="mono"><a href="#arpa.parse_args">parse_args</a></li>
    <li class="mono"><a href="#arpa.post">post</a></li>
    <li class="mono"><a href="#arpa.process">process</a></li>
    <li class="mono"><a href="#arpa.process_graph">process_graph</a></li>
    <li class="mono"><a href="#arpa.prune_candidates">prune_candidates</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#arpa.Arpa">Arpa</a></span>
        
          
  <ul>
    <li class="mono"><a href="#arpa.Arpa.__init__">__init__</a></li>
    <li class="mono"><a href="#arpa.Arpa.extract_uris">extract_uris</a></li>
    <li class="mono"><a href="#arpa.Arpa.get_candidates">get_candidates</a></li>
    <li class="mono"><a href="#arpa.Arpa.get_distinct_mentions">get_distinct_mentions</a></li>
    <li class="mono"><a href="#arpa.Arpa.get_uri_matches">get_uri_matches</a></li>
    <li class="mono"><a href="#arpa.Arpa.query">query</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#arpa.ArpaMimic">ArpaMimic</a></span>
        
          
  <ul>
    <li class="mono"><a href="#arpa.ArpaMimic.__init__">__init__</a></li>
    <li class="mono"><a href="#arpa.ArpaMimic.extract_uris">extract_uris</a></li>
    <li class="mono"><a href="#arpa.ArpaMimic.get_candidates">get_candidates</a></li>
    <li class="mono"><a href="#arpa.ArpaMimic.get_distinct_mentions">get_distinct_mentions</a></li>
    <li class="mono"><a href="#arpa.ArpaMimic.get_uri_matches">get_uri_matches</a></li>
    <li class="mono"><a href="#arpa.ArpaMimic.query">query</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">arpa</span> module</h1>
  <p>A module for linking resources to an RDF graph with an <a href="https://github.com/jiemakel/arpa">ARPA</a> service.</p>
<h2>Requirements<a name="requirements"></a></h2>
<p>Python 3, <a href="http://rdflib.readthedocs.org/en/latest/">RDFLib</a> and <a href="http://docs.python-requests.org/en/latest/">Requests</a></p>
<p>If you want to see a progress bar, you'll need <a href="https://github.com/rasbt/pyprind">PyPrind</a>.</p>
<h2>Usage<a name="usage"></a></h2>
<p>The module can be invoked as a script from the command line or by calling <a href="#arpa.arpafy"><code>arpafy</code></a> (or <a href="#arpa.process"><code>process</code></a>) in your Python code.</p>
<pre style="padding:5px">
usage: arpa.py [-h] [--fi INPUT_FORMAT] [--fo OUTPUT_FORMAT] [-n] [-c]
               [--rdf_class CLASS] [--prop PROPERTY]
               [--ignore [TERM [TERM ...]]] [--min_ngram N]
               [--no_duplicates [TYPE [TYPE ...]]] [-r N] [-w N]
               [--log_level {NOTSET,DEBUG,INFO,WARNING,ERROR,CRITICAL}]
               input output target_property arpa

Link resources to an RDF graph with ARPA.

positional arguments:
  input                 Input rdf file
  output                Output file
  target_property       Target property for the matches
  arpa                  ARPA service URL

optional arguments:
  -h, --help            show this help message and exit
  --fi INPUT_FORMAT     Input file format (rdflib parser). Will be guessed if
                        omitted.
  --fo OUTPUT_FORMAT    Output file format (rdflib serializer). Default is
                        turtle.
  -n, --new_graph       Add the ARPA results to a new graph instead of the
                        original. The output file contains all the triples of
                        the original graph by default. With this argument set
                        the output file will contain only the results.
  -c, --candidates_only
                        Get candidates (n-grams) only from ARPA.
  --rdf_class CLASS     Process only subjects of the given type (goes through
                        all subjects by default).
  --prop PROPERTY       Property that's value is to be used in matching.
                        Default is skos:prefLabel.
  --ignore [TERM [TERM ...]]
                        Terms that should be ignored even if matched
  --min_ngram N         The minimum ngram length that is considered a match.
                        Default is 1.
  --no_duplicates [TYPE [TYPE ...]]
                        Remove duplicate matches based on the 'label' returned
                        by the ARPA service. Here 'duplicate' means a subject
                        with the same label as another subject in the same
                        result set. A list of types can be given with this
                        argument. If given, prioritize matches based on it -
                        the first given type will get the highest priority and
                        so on. Note that the response from the service has to
                        include a 'type' variable for this to work.
  -r N, --retries N     The amount of retries per query if a HTTP error is
                        received. Default is 0.
  -w N, --wait N        The number of seconds to wait between retries. Only
                        has an effect if number of retries is set. Default is
                        1 second.
  --log_level {NOTSET,DEBUG,INFO,WARNING,ERROR,CRITICAL}
                        Logging level, default is INFO. The log file is
                        arpa_linker.log.
</pre>

<p>The arguments can also be read from a file using "@" (example arg file <a href="https://github.com/SemanticComputing/python-arpa-linker/blob/master/arpa.args">arpa.args</a>):</p>
<p><code>$ python3 arpa.py @arpa.args</code></p>
<h2>Examples<a name="examples"></a></h2>
<p>See <a href="https://github.com/SemanticComputing/warsa-linkers">this repo</a> for code examples,
and <a href="https://github.com/SemanticComputing/python-arpa-linker/blob/master/arpa.args">arpa.args</a> for an example arg file.</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa', this);">Show source &equiv;</a></p>
  <div id="source-arpa" class="source">
    <div class="codehilite"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A module for linking resources to an RDF graph with an [ARPA](https://github.com/jiemakel/arpa) service.</span>

<span class="sd">## Requirements&lt;a name=&quot;requirements&quot;&gt;&lt;/a&gt;</span>
<span class="sd">Python 3, [RDFLib](http://rdflib.readthedocs.org/en/latest/) and [Requests](http://docs.python-requests.org/en/latest/)</span>

<span class="sd">If you want to see a progress bar, you&#39;ll need [PyPrind](https://github.com/rasbt/pyprind).</span>

<span class="sd">## Usage&lt;a name=&quot;usage&quot;&gt;&lt;/a&gt;</span>

<span class="sd">The module can be invoked as a script from the command line or by calling `arpa.arpafy` (or `arpa.process`) in your Python code.</span>

<span class="sd">&lt;pre style=&quot;padding:5px&quot;&gt;</span>
<span class="sd">usage: arpa.py [-h] [--fi INPUT_FORMAT] [--fo OUTPUT_FORMAT] [-n] [-c]</span>
<span class="sd">               [--rdf_class CLASS] [--prop PROPERTY]</span>
<span class="sd">               [--ignore [TERM [TERM ...]]] [--min_ngram N]</span>
<span class="sd">               [--no_duplicates [TYPE [TYPE ...]]] [-r N] [-w N]</span>
<span class="sd">               [--log_level {NOTSET,DEBUG,INFO,WARNING,ERROR,CRITICAL}]</span>
<span class="sd">               input output target_property arpa</span>

<span class="sd">Link resources to an RDF graph with ARPA.</span>

<span class="sd">positional arguments:</span>
<span class="sd">  input                 Input rdf file</span>
<span class="sd">  output                Output file</span>
<span class="sd">  target_property       Target property for the matches</span>
<span class="sd">  arpa                  ARPA service URL</span>

<span class="sd">optional arguments:</span>
<span class="sd">  -h, --help            show this help message and exit</span>
<span class="sd">  --fi INPUT_FORMAT     Input file format (rdflib parser). Will be guessed if</span>
<span class="sd">                        omitted.</span>
<span class="sd">  --fo OUTPUT_FORMAT    Output file format (rdflib serializer). Default is</span>
<span class="sd">                        turtle.</span>
<span class="sd">  -n, --new_graph       Add the ARPA results to a new graph instead of the</span>
<span class="sd">                        original. The output file contains all the triples of</span>
<span class="sd">                        the original graph by default. With this argument set</span>
<span class="sd">                        the output file will contain only the results.</span>
<span class="sd">  -c, --candidates_only</span>
<span class="sd">                        Get candidates (n-grams) only from ARPA.</span>
<span class="sd">  --rdf_class CLASS     Process only subjects of the given type (goes through</span>
<span class="sd">                        all subjects by default).</span>
<span class="sd">  --prop PROPERTY       Property that&#39;s value is to be used in matching.</span>
<span class="sd">                        Default is skos:prefLabel.</span>
<span class="sd">  --ignore [TERM [TERM ...]]</span>
<span class="sd">                        Terms that should be ignored even if matched</span>
<span class="sd">  --min_ngram N         The minimum ngram length that is considered a match.</span>
<span class="sd">                        Default is 1.</span>
<span class="sd">  --no_duplicates [TYPE [TYPE ...]]</span>
<span class="sd">                        Remove duplicate matches based on the &#39;label&#39; returned</span>
<span class="sd">                        by the ARPA service. Here &#39;duplicate&#39; means a subject</span>
<span class="sd">                        with the same label as another subject in the same</span>
<span class="sd">                        result set. A list of types can be given with this</span>
<span class="sd">                        argument. If given, prioritize matches based on it -</span>
<span class="sd">                        the first given type will get the highest priority and</span>
<span class="sd">                        so on. Note that the response from the service has to</span>
<span class="sd">                        include a &#39;type&#39; variable for this to work.</span>
<span class="sd">  -r N, --retries N     The amount of retries per query if a HTTP error is</span>
<span class="sd">                        received. Default is 0.</span>
<span class="sd">  -w N, --wait N        The number of seconds to wait between retries. Only</span>
<span class="sd">                        has an effect if number of retries is set. Default is</span>
<span class="sd">                        1 second.</span>
<span class="sd">  --log_level {NOTSET,DEBUG,INFO,WARNING,ERROR,CRITICAL}</span>
<span class="sd">                        Logging level, default is INFO. The log file is</span>
<span class="sd">                        arpa_linker.log.</span>
<span class="sd">&lt;/pre&gt;</span>

<span class="sd">The arguments can also be read from a file using &quot;@&quot; (example arg file [arpa.args](https://github.com/SemanticComputing/python-arpa-linker/blob/master/arpa.args)):</span>

<span class="sd">`$ python3 arpa.py @arpa.args`</span>

<span class="sd">## Examples&lt;a name=&quot;examples&quot;&gt;&lt;/a&gt;</span>

<span class="sd">See [this repo](https://github.com/SemanticComputing/warsa-linkers) for code examples,</span>
<span class="sd">and [arpa.args](https://github.com/SemanticComputing/python-arpa-linker/blob/master/arpa.args) for an example arg file.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">HTTPError</span>
<span class="kn">from</span> <span class="nn">rdflib</span> <span class="kn">import</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">from</span> <span class="nn">rdflib.namespace</span> <span class="kn">import</span> <span class="n">RDF</span><span class="p">,</span> <span class="n">SKOS</span>
<span class="kn">from</span> <span class="nn">rdflib.util</span> <span class="kn">import</span> <span class="n">guess_format</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Arpa&#39;</span><span class="p">,</span> <span class="s1">&#39;ArpaMimic&#39;</span><span class="p">,</span> <span class="s1">&#39;arpafy&#39;</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">,</span> <span class="s1">&#39;process_graph&#39;</span><span class="p">,</span> <span class="s1">&#39;prune_candidates&#39;</span><span class="p">,</span>
            <span class="s1">&#39;combine_candidates&#39;</span><span class="p">,</span> <span class="s1">&#39;map_results&#39;</span><span class="p">,</span> <span class="s1">&#39;log_to_file&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;parse_args&#39;</span><span class="p">,</span>
            <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;LABEL_PROP&#39;</span><span class="p">,</span> <span class="s1">&#39;TYPE_PROP&#39;</span><span class="p">]</span>

<span class="n">LABEL_PROP</span> <span class="o">=</span> <span class="s1">&#39;label&#39;</span>
<span class="sd">&quot;&quot;&quot;The name of the property containing the label of the match in the ARPA results.&quot;&quot;&quot;</span>

<span class="n">TYPE_PROP</span> <span class="o">=</span> <span class="s1">&#39;type&#39;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The name of the property containing the type of the match in the ARPA results-&gt;properties.</span>
<span class="sd">Only needed for prioritized duplicate removal.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c1"># Hide requests INFO logging spam</span>
<span class="n">requests_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;requests&#39;</span><span class="p">)</span>
<span class="n">requests_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_value</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">type_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;literal&#39;</span><span class="p">:</span>
        <span class="n">datatype</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datatype&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&quot;{}&quot;^^{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datatype</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&quot;{}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;uri&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;{}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">map_results</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map general SPARQL results to the format ARPA returns.</span>

<span class="sd">    Return the mapped results.</span>

<span class="sd">    `results` is the SPARQL result as a dict. Each row has to include an &#39;id&#39; variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Mapping results {} to ARPA format&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;bindings&#39;</span><span class="p">]:</span>
        <span class="n">o_id</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">index</span> <span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">o_id</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">_get_value</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">o</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">o_id</span><span class="p">,</span>
                <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;matches&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ngram&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)],</span>
                <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="n">props</span>
            <span class="p">}</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">ngram</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ngram&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ngram</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;matches&#39;</span><span class="p">]:</span>
                <span class="n">o</span><span class="p">[</span><span class="s1">&#39;matches&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ngram</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_get_value</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">_get_value</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Mapped to: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a post request to the given URL with the given data, expecting a JSON response.</span>
<span class="sd">    Throws a HTTPError if the request fails (after retries, if any) or if JSON</span>
<span class="sd">    parsing fails.</span>

<span class="sd">    `url` is the URL to send the request to.</span>

<span class="sd">    `data` is a dict containing the data to send to the URL.</span>

<span class="sd">    `retries` is the number of retries to attempt if the request fails. Optional.</span>

<span class="sd">    `wait` is the number of seconds to wait between retries. Optional, default is 1 second.</span>
<span class="sd">    Has no effect if `retries` is not set.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid amount of retries: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retries</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">wait</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid retry wait time: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wait</span><span class="p">))</span>

    <span class="n">tries</span> <span class="o">=</span> <span class="n">retries</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">tries</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Sending request to {} with data: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">HTTPError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">tries</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">tries</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Received error ({}) from {} with request data: {}.&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Waiting {} seconds before retrying&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wait</span><span class="p">))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">retries</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Error {}, out of retries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="s1">&#39;Error ({}) from {} with request data: {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Success</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Success, received: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">res</span>


<span class="k">class</span> <span class="nc">Arpa</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class representing the ARPA service&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">remove_duplicates</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">min_ngram_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">retries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wait_between_tries</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Arpa service object.</span>

<span class="sd">        `url` is the ARPA service url.</span>

<span class="sd">        If `remove_duplicates` is `True`, choose only one subject out of all the</span>
<span class="sd">        matched subjects that have the same label (arbitrarily).</span>
<span class="sd">        If, instead, the value is a list or a tuple, assume that it represents</span>
<span class="sd">        a list of class names and prefer those classes when choosing</span>
<span class="sd">        the subject. The ARPA results must include a property (`arpa.TYPE_PROP`)</span>
<span class="sd">        that has the class of the match as the value. Optional.</span>

<span class="sd">        `min_ngram_length` is the minimum ngram match length that will be included when</span>
<span class="sd">        returning the query results. Optional.</span>

<span class="sd">        `ignore` is a list of matches that should be removed from the results (case insensitive).</span>
<span class="sd">        Optional.</span>

<span class="sd">        `retries` is the number of retries per query. Optional.</span>

<span class="sd">        `wait_between_tries` is the amount of times in seconds to wait between retries.</span>
<span class="sd">        Optional, default is 1 second. Has no effect if `retries` is not set.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Initialize Arpa instance&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Number of retries has to be a non-negative number, got {}&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retries</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">wait_between_tries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Retry wait time has to be a non-negative number, got {}&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wait_between_tries</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_retries</span> <span class="o">=</span> <span class="n">retries</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ignore</span> <span class="ow">or</span> <span class="p">[]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_ngram_length</span> <span class="o">=</span> <span class="n">min_ngram_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">=</span> <span class="n">wait_between_tries</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">remove_duplicates</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span> <span class="o">=</span> <span class="n">remove_duplicates</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;&lt;{}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">remove_duplicates</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA ignore set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA url set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA min_ngram_length set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_ngram_length</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA no_duplicates set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA retries set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_retries</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_remove_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove duplicates from the entries.</span>

<span class="sd">        A &#39;duplicate&#39; is an entry with the same `LABEL_PROP` property value.</span>

<span class="sd">        If `self._no_duplicates == True`, choose the subject to keep any which way.</span>

<span class="sd">        If `self._no_duplicates` is a tuple (or a list), choose the kept subject</span>
<span class="sd">        by comparing its type to the types contained in the tuple. The lower the</span>
<span class="sd">        index of the type in the tuple, the higher the priority.</span>

<span class="sd">        `entries` is the ARPA service results as a JSON object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">entries</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">add</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">add</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">LABEL_PROP</span><span class="p">]</span> <span class="ow">in</span> <span class="n">labels</span>
                <span class="c1"># If the label is not in the labels set, add it to the set.</span>
                <span class="c1"># This works because set.add() returns None.</span>
                <span class="ow">or</span> <span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">LABEL_PROP</span><span class="p">]))]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span><span class="p">:</span>
            <span class="c1"># self._no_duplicates is a tuple - prioritize types defined in it</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">LABEL_PROP</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="c1"># Get the types of the latest most preferrable entry that</span>
                <span class="c1"># had the same label as this one</span>
                <span class="n">prev_match_types</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x_label</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TYPE_PROP</span><span class="p">,</span> <span class="p">[])</span>
                <span class="c1"># Get matches from the preferred types for the previously selected entry</span>
                <span class="n">prev_pref</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">prev_match_types</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Find the priority of the previously selected entry</span>
                    <span class="n">prev_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">prev_pref</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># No previous entry or previous entry doesn&#39;t have a preferred type</span>
                    <span class="n">prev_idx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                <span class="c1"># Get matches in the preferred types for this entry</span>
                <span class="n">pref</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">TYPE_PROP</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">pref</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># This one is not of a preferred type</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">prev_match_types</span><span class="p">)</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">prev_idx</span><span class="p">:</span>
                    <span class="c1"># There is no previous entry with this label or</span>
                    <span class="c1"># the current match has a higher priority preferred type</span>
                    <span class="n">items</span><span class="p">[</span><span class="n">x_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>

            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_filter_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">get_len</span><span class="p">,</span> <span class="n">get_label</span><span class="p">,</span> <span class="n">skip_remove_duplicates</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal filter function used by `arpa.Arpa._filter`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Filter ignored results</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">get_label</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span><span class="p">]</span>

        <span class="c1"># Filter by minimum ngram length</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_ngram_length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">get_len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_ngram_length</span><span class="p">]</span>

        <span class="c1"># Remove duplicates unless requested to skip</span>
        <span class="k">if</span> <span class="n">skip_remove_duplicates</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_duplicates</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">candidates</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter matches based on `self._ignore` and remove matches that are</span>
<span class="sd">        for ngrams with length less than `self.min_ngram_length`.</span>

<span class="sd">        Return the response with the ignored matches removed.</span>

<span class="sd">        `results` is the parsed ARPA service results.</span>

<span class="sd">        `candidates` is whether or not the results contain just the candidates.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Filtering candidates&#39;</span><span class="p">)</span>
            <span class="n">get_len</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="n">get_label</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="c1"># No use in removing literal duplicates</span>
            <span class="n">skip_remove_duplicates</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Filtering results&#39;</span><span class="p">)</span>
            <span class="n">get_len</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;ngram&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="n">get_label</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">LABEL_PROP</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">skip_remove_duplicates</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">get_len</span><span class="p">,</span> <span class="n">get_label</span><span class="p">,</span> <span class="n">skip_remove_duplicates</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sanitize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="c1"># Remove quotation marks and brackets - ARPA can return an error if they&#39;re present</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">text</span>
        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">candidates</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the ARPA service and return the response results as JSON</span>

<span class="sd">        Results will be filtered if a filter was specified at init.</span>

<span class="sd">        `text` is the text used in the query.</span>

<span class="sd">        If `candidates` is set, query for candidates only.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Query ARPA at {} with text {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>

        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Empty ARPA query text&#39;</span><span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;?cgen&#39;</span> <span class="k">if</span> <span class="n">candidates</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Query the ARPA service with the text</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_retries</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_wait</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">candidates</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_uris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the URIs from results.</span>

<span class="sd">        `results` is the results as returned by `arpa.query`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">URIRef</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_distinct_mentions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get distinct mentions (i.e. matches) that yielded results.</span>

<span class="sd">        `results` is the results as returned by `arpa.query`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">m</span> <span class="k">for</span> <span class="n">ml</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;matches&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ml</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_uri_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query ARPA and return a dict with a list of uris of resources that match the text.</span>

<span class="sd">        Return a dict where &#39;results&#39; has the list of uris, &#39;mentions&#39; has the mentions</span>
<span class="sd">        that yielded results, and &#39;pre_validation_mentions&#39; has mentions that yielded</span>
<span class="sd">        results before running the `validator`.</span>

<span class="sd">        `text` is the text to use in the query.</span>

<span class="sd">        `validator` is an object that implements a `validate` method that takes</span>
<span class="sd">        the results and `text` (and any other parameters passed to this method)</span>
<span class="sd">        as parameters, and returns a subset of the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting URI matches: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="n">pre_validation_mentions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">post_validation_mentions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">validator</span> <span class="ow">and</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Validating results: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
            <span class="n">pre_validation_mentions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distinct_mentions</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Distinct mentions before validation: {} ({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pre_validation_mentions</span><span class="p">),</span> <span class="n">pre_validation_mentions</span><span class="p">))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found matches {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
            <span class="n">post_validation_mentions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distinct_mentions</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Distinct mentions: {} ({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">post_validation_mentions</span><span class="p">),</span> <span class="n">post_validation_mentions</span><span class="p">))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_uris</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No matches found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="s1">&#39;mentions&#39;</span><span class="p">:</span> <span class="n">post_validation_mentions</span><span class="p">,</span>
            <span class="s1">&#39;pre_validation_mentions&#39;</span><span class="p">:</span> <span class="n">pre_validation_mentions</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the candidates from `text` that would be used by the ARPA service</span>
<span class="sd">        to query for matches.</span>

<span class="sd">        A dict is returned for compatibility with `arpa.get_uri_matches`.</span>

<span class="sd">        Return a dict where &#39;results&#39; has the candidates as a list of rdflib Literals.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Empty ARPA query text&#39;</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">candidates</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Received candidates: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Literal</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span> <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]}</span>

        <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">ArpaMimic</span><span class="p">(</span><span class="n">Arpa</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that behaves like `arpa.Arpa` except that it queries a SPARQL endpoint</span>
<span class="sd">    instead of an ARPA service.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_template</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the ArpaMimic instance.</span>

<span class="sd">        `query_template` is a SPARQL query template like ARPA uses.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">query_template</span> <span class="o">=</span> <span class="n">query_template</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">url_params</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query a SPARQL endpoint and return the response results as JSON mapped</span>
<span class="sd">        as if returned by ARPA.</span>

<span class="sd">        `text` is the text used in the query.</span>

<span class="sd">        `url_params` is any URL parameters to be added to the URL.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Querying {} with text {} using ArpaMimic&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Empty query text&#39;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;VALUES&gt;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">+</span> <span class="n">url_params</span>

        <span class="c1"># Query the endpoint with the text</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_retries</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_wait</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">map_results</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">[]))</span>


<span class="k">class</span> <span class="nc">Bar</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mock progress bar implementation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">def</span> <span class="nf">get_bar</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">use_pyprind</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a progress bar.</span>

<span class="sd">    `n` is the number of iterations for the progress bar.</span>

<span class="sd">    If `use_pyprind` is true, try to return a `pyprind.ProgBar` instance. Otherwise,</span>
<span class="sd">    return a mock progress bar.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">use_pyprind</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pyprind</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Using pyprind progress bar&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pyprind</span><span class="o">.</span><span class="n">ProgBar</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Tried to use pyprind progress bar but pyprind is not available&#39;</span><span class="p">)</span>
            <span class="k">pass</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Using mock progress bar&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Bar</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_subgraph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="n">rdf_class</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">subgraph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">rdf_class</span><span class="p">:</span>
        <span class="c1"># Filter out subjects that are not of the given type</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">subjects</span><span class="p">(</span><span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">rdf_class</span><span class="p">):</span>
            <span class="n">subgraph</span> <span class="o">+=</span> <span class="n">graph</span><span class="o">.</span><span class="n">triples</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subgraph</span> <span class="o">+=</span> <span class="n">graph</span><span class="o">.</span><span class="n">triples</span><span class="p">((</span><span class="bp">None</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">subgraph</span>


<span class="k">def</span> <span class="nf">arpafy</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">target_prop</span><span class="p">,</span> <span class="n">arpa</span><span class="p">,</span> <span class="n">source_prop</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rdf_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">output_graph</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">preprocessor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">candidates_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Link a property to resources using ARPA. Modify the graph in place,</span>
<span class="sd">    unless `output_graph` is given.</span>

<span class="sd">    Return a dict with the amount of processed triples (processed), the resulting graph (graph),</span>
<span class="sd">    match count (matches) and errors encountered (errors).</span>

<span class="sd">    `graph` is the graph to link (will be modified unless `output_graph` is defined.</span>

<span class="sd">    `target_prop` is the property name that is used for saving the link.</span>

<span class="sd">    `arpa` is the `arpa.Arpa` class instance.</span>

<span class="sd">    `source_prop` is the property that&#39;s value will be used when querying ARPA (if omitted, skos:prefLabel is used).</span>

<span class="sd">    If `rdf_class` is given, only go through instances of this type.</span>

<span class="sd">    `output_graph` is the graph to which the results should be added. If not given, the results will be added</span>
<span class="sd">    to the input `graph`.</span>

<span class="sd">    `preprocessor` is an optional function that processes the query text before it is used in the ARPA query.</span>
<span class="sd">    It receives whatever is the value of `source_prop` for the current subject, the current subject, and the graph.</span>

<span class="sd">    `validator` is an object with a `validate` method that takes the ARPA results, query text, and the processed</span>
<span class="sd">    subject as parameters, and returns a subset of the results (that have been validated based on the subject,</span>
<span class="sd">    graph and results). Optional.</span>

<span class="sd">    If `candidates_only` is set, get candidates (n-grams) only from ARPA.</span>

<span class="sd">    If `progress` is `True`, show a progress bar. Requires pyprind.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">source_prop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">source_prop</span> <span class="o">=</span> <span class="n">SKOS</span><span class="p">[</span><span class="s1">&#39;prefLabel&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">output_graph</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">output_graph</span> <span class="o">=</span> <span class="n">graph</span>
    <span class="k">if</span> <span class="n">candidates_only</span><span class="p">:</span>
        <span class="n">get_results</span> <span class="o">=</span> <span class="n">arpa</span><span class="o">.</span><span class="n">get_candidates</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">get_results</span> <span class="o">=</span> <span class="n">arpa</span><span class="o">.</span><span class="n">get_uri_matches</span>

    <span class="n">subgraph</span> <span class="o">=</span> <span class="n">_get_subgraph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="n">rdf_class</span><span class="p">)</span>

    <span class="n">triple_match_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">subject_match_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pre_validation_mention_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">post_validation_mention_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">bar</span> <span class="o">=</span> <span class="n">get_bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="p">),</span> <span class="n">progress</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">subject_objects</span><span class="p">():</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span> <span class="k">if</span> <span class="n">preprocessor</span> <span class="k">else</span> <span class="n">o</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_dict</span> <span class="o">=</span> <span class="n">get_results</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">HTTPError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error getting matches from ARPA&#39;</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span>
            <span class="n">triple_match_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">pre_validation_mention_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pre_validation_mentions&#39;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">subject_match_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">post_validation_mention_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mentions&#39;</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="c1"># Add each result as a value of the target property</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">output_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">target_prop</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;graph&#39;</span><span class="p">:</span> <span class="n">output_graph</span><span class="p">,</span>
        <span class="s1">&#39;processed&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="p">),</span>
        <span class="s1">&#39;matches&#39;</span><span class="p">:</span> <span class="n">triple_match_count</span><span class="p">,</span>
        <span class="s1">&#39;subjects_matched&#39;</span><span class="p">:</span> <span class="n">subject_match_count</span><span class="p">,</span>
        <span class="s1">&#39;pre_validation_mention_count&#39;</span><span class="p">:</span> <span class="n">pre_validation_mention_count</span><span class="p">,</span>
        <span class="s1">&#39;post_validation_mention_count&#39;</span><span class="p">:</span> <span class="n">post_validation_mention_count</span><span class="p">,</span>
        <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">errors</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processed {} triples, found {} matches from {} mentions&#39;</span>
                <span class="s1">&#39; with {} total mentions ({} errors)&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;matches&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;post_validation_mention_count&#39;</span><span class="p">],</span>
                    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;pre_validation_mention_count&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">])))</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">prune_candidates</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="n">pruner</span><span class="p">,</span> <span class="n">rdf_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">output_graph</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prune undesired candidates.</span>

<span class="sd">    Return a dict with the amount of candidates left after pruning (result_count),</span>
<span class="sd">    and the resulting graph (graph).</span>

<span class="sd">    `graph` is the graph containing the candidates. Will be modified if `output_graph`</span>
<span class="sd">    is not given.</span>

<span class="sd">    `source_prop` is the property in the graph that has the candidates as its value.</span>

<span class="sd">    `pruner` is a function that receives a single candidate as string and returns</span>
<span class="sd">    a falsey value if the candidate should not be added to the output graph, and</span>
<span class="sd">    otherwise a string (the candidate, possibly modified) that should be added</span>
<span class="sd">    to the output graph.</span>

<span class="sd">    If `rdf_class` is given, only go through instances of this type.</span>

<span class="sd">    `output_graph` is the graph to which the results should be added.</span>
<span class="sd">    If not given, the results will be added to the input `graph`,</span>
<span class="sd">    and the old candidates removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Pruning candidates&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_graph</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">output_graph</span> <span class="o">=</span> <span class="n">graph</span>

    <span class="n">subgraph</span> <span class="o">=</span> <span class="n">_get_subgraph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="n">rdf_class</span><span class="p">)</span>

    <span class="n">bar</span> <span class="o">=</span> <span class="n">get_bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="p">),</span> <span class="n">progress</span><span class="p">)</span>

    <span class="n">result_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">subject_objects</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pruner</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
        <span class="c1"># Remove the original candidate</span>
        <span class="n">output_graph</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Add the pruned candidate to the output graph</span>
            <span class="n">output_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;graph&#39;</span><span class="p">:</span> <span class="n">output_graph</span><span class="p">,</span>
        <span class="s1">&#39;result_count&#39;</span><span class="p">:</span> <span class="n">result_count</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Candidate pruning complete&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">log_to_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function for setting up logging to file.</span>

<span class="sd">    `file_name` is the log file name.</span>

<span class="sd">    `level` is the log level name (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">level</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse command line arguments. See [Usage](#usage) (or the source code) for details.</span>

<span class="sd">    `args` is the list of command line arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">argparser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Link resources to an RDF graph with ARPA.&quot;</span><span class="p">,</span>
            <span class="n">fromfile_prefix_chars</span><span class="o">=</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Input rdf file&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output file&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;tprop&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;target_property&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Target property for the matches&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;arpa&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;ARPA service URL&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--fi&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;INPUT_FORMAT&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Input file format (rdflib parser). Will be guessed if omitted.&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--fo&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;OUTPUT_FORMAT&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output file format (rdflib serializer). Default is turtle.&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;turtle&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="s2">&quot;--new_graph&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Add the ARPA results to a new graph instead of the original. The output file</span>
<span class="s2">        contains all the triples of the original graph by default. With this argument set</span>
<span class="s2">        the output file will contain only the results.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--candidates_only&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Get candidates (n-grams) only from ARPA.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--rdf_class&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;CLASS&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Process only subjects of the given type (goes through all subjects by default).&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--prop&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;PROPERTY&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Property that&#39;s value is to be used in matching. Default is skos:prefLabel.&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ignore&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TERM&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Terms that should be ignored even if matched&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--min_ngram&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The minimum ngram length that is considered a match. Default is 1.&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--no_duplicates&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TYPE&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Remove duplicate matches based on the &#39;label&#39; returned by the ARPA service.</span>
<span class="s2">        Here &#39;duplicate&#39; means a subject with the same label as another subject in</span>
<span class="s2">        the same result set.</span>
<span class="s2">        A list of types can be given with this argument. If given, prioritize matches</span>
<span class="s2">        based on it - the first given type will get the highest priority and so on.</span>
<span class="s2">        Note that the response from the service has to include a &#39;type&#39; variable</span>
<span class="s2">        for this to work.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="s2">&quot;--retries&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The amount of retries per query if a HTTP error is received. Default is 0.&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-w&quot;</span><span class="p">,</span> <span class="s2">&quot;--wait&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The number of seconds to wait between retries. Only has an effect if number</span>
<span class="s2">        of retries is set. Default is 1 second.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--log_level&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;NOTSET&quot;</span><span class="p">,</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">,</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s2">&quot;CRITICAL&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Logging level, default is INFO. The log file is arpa_linker.log.&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">fi</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">fi</span> <span class="o">=</span> <span class="n">guess_format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">prop</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="n">URIRef</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">prop</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">rdf_class</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">rdf_class</span> <span class="o">=</span> <span class="n">URIRef</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">rdf_class</span><span class="p">)</span>

    <span class="n">args</span><span class="o">.</span><span class="n">tprop</span> <span class="o">=</span> <span class="n">URIRef</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tprop</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_duplicates</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_duplicates</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="n">args</span>


<span class="k">def</span> <span class="nf">combine_candidates</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">output_graph</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rdf_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine each subject&#39;s candidates into a single string.</span>

<span class="sd">    Return the resulting graph.</span>

<span class="sd">    `graph` is the graph containing the candidates. Will be modified if `output_graph`</span>
<span class="sd">    is not given.</span>

<span class="sd">    `prop` is the URIRef of the property containing the candidates.</span>

<span class="sd">    `output_graph` is the graph to which the results should be added.</span>
<span class="sd">    If not given, `graph` will be modified.</span>

<span class="sd">    If `rdf_class` is given, only go through instances of this type.</span>

<span class="sd">    If `progress` is set, display a progress bar.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">subgraph</span> <span class="o">=</span> <span class="n">_get_subgraph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">rdf_class</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Combining candidates&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_graph</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">output_graph</span> <span class="o">=</span> <span class="n">graph</span>

    <span class="n">subjects</span> <span class="o">=</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">subjects</span><span class="p">()</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">get_bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="p">),</span> <span class="n">progress</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> </span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span>
        <span class="c1"># Remove the original candidate</span>
        <span class="n">output_graph</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="n">output_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">combined</span><span class="p">)))</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Candidates combined succesfully&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_graph</span>


<span class="k">def</span> <span class="nf">process_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">new_graph</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">prune</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">join_candidates</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">run_arpafy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">source_prop</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rdf_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pruner</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function for running different tasks related to linking.</span>

<span class="sd">    `graph` is the graph to be processed.</span>

<span class="sd">    If `new_graph` is set, use a new empty graph for adding the results.</span>

<span class="sd">    If `prune` is set, prune candidates using `arpa.prune_candidates`.</span>

<span class="sd">    If `join_candidates` is set, combine candidates into a single value using</span>
<span class="sd">    `arpa.combine_candidates`.</span>

<span class="sd">    Setting `run_arpafy` to False will skip running `arpa.arpafy`.</span>
<span class="sd">    Useful with `join_candidates`.</span>

<span class="sd">    `source_prop` is the property URI that contains the values to be processed.</span>

<span class="sd">    For `pruner` see `arpa.prune_candidates`.</span>

<span class="sd">    If `progress` is `True`, show a progress bar. Requires pyprind.</span>

<span class="sd">    All other arguments are passed to `arpa.arpafy` (if run).</span>

<span class="sd">    Return the results dict as returned by `arpa.arpafy`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">new_graph</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Output to new graph&#39;</span><span class="p">)</span>
        <span class="n">output_graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
        <span class="n">output_graph</span><span class="o">.</span><span class="n">namespace_manager</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">namespace_manager</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_graph</span> <span class="o">=</span> <span class="n">graph</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Begin processing&#39;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">prune</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Prune candidates&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">prune_candidates</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="n">pruner</span><span class="p">,</span>
                <span class="n">rdf_class</span><span class="o">=</span><span class="n">rdf_class</span><span class="p">,</span> <span class="n">output_graph</span><span class="o">=</span><span class="n">output_graph</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">join_candidates</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Combine candidates&#39;</span><span class="p">)</span>
        <span class="n">output_graph</span> <span class="o">=</span> <span class="n">combine_candidates</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span>
                <span class="n">output_graph</span><span class="o">=</span><span class="n">output_graph</span><span class="p">,</span> <span class="n">rdf_class</span><span class="o">=</span><span class="n">rdf_class</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">output_graph</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;graph&#39;</span><span class="p">:</span> <span class="n">output_graph</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">run_arpafy</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Start arpafy&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">arpafy</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">source_prop</span><span class="o">=</span><span class="n">source_prop</span><span class="p">,</span> <span class="n">rdf_class</span><span class="o">=</span><span class="n">rdf_class</span><span class="p">,</span>
                <span class="n">output_graph</span><span class="o">=</span><span class="n">output_graph</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing complete, runtime {}&#39;</span><span class="o">.</span>
            <span class="n">format</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">input_format</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">output_format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="n">validator_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse the given input file, run `arpa.arpafy`, and serialize the resulting</span>
<span class="sd">    graph on disk.</span>

<span class="sd">    `input_file` is the name of the rdf file to be parsed.</span>

<span class="sd">    `input_format` is the input file format.</span>

<span class="sd">    `output_file` is the output file name.</span>

<span class="sd">    `output_format` is the output file format.</span>

<span class="sd">    `validator_class` is class that takes the input graph as parameter, and implements</span>
<span class="sd">    a `validate` method. See `arpa.arpafy` for more information.</span>
<span class="sd">    This overrides any validator object given as the `arpa.arpafy` `validator` parameter.</span>

<span class="sd">    All other arguments are passed to `arpa.process_graph`.</span>

<span class="sd">    Return the results dict as returned by `arpa.arpafy`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Parsing file {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_file</span><span class="p">))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">input_format</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Parsing complete&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">validator_class</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;validator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">validator_class</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">process_graph</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">output_graph</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Serializing graph as {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">))</span>
    <span class="n">output_graph</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">destination</span><span class="o">=</span><span class="n">output_file</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">output_format</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Serialization complete&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function for running via the command line.</span>

<span class="sd">    `args` is the list of command line arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">log_to_file</span><span class="p">(</span><span class="s1">&#39;arpa_linker.log&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

    <span class="n">arpa</span> <span class="o">=</span> <span class="n">Arpa</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">arpa</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">no_duplicates</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">min_ngram</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ignore</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">retries</span><span class="p">)</span>

    <span class="c1"># Query the ARPA service, add the matches and serialize graph to disk</span>
    <span class="n">process</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">fi</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">fo</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">tprop</span><span class="p">,</span> <span class="n">arpa</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">rdf_class</span><span class="p">,</span> <span class="n">new_graph</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">new_graph</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">candidates_only</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">candidates_only</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">
    <h2 class="section-title" id="header-variables">Module variables</h2>
      <div class="item">
      <p id="arpa.LABEL_PROP" class="name">var <span class="ident">LABEL_PROP</span></p>
      
  
    <div class="desc"><p>The name of the property containing the label of the match in the ARPA results.</p></div>
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="arpa.TYPE_PROP" class="name">var <span class="ident">TYPE_PROP</span></p>
      
  
    <div class="desc"><p>The name of the property containing the type of the match in the ARPA results-&gt;properties.
Only needed for prioritized duplicate removal.</p></div>
  <div class="source_cont">
</div>

      </div>

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="arpa.arpafy">
    <p>def <span class="ident">arpafy</span>(</p><p>graph, target_prop, arpa, source_prop=None, rdf_class=None, output_graph=None, preprocessor=None, validator=None, candidates_only=False, progress=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Link a property to resources using ARPA. Modify the graph in place,
unless <code>output_graph</code> is given.</p>
<p>Return a dict with the amount of processed triples (processed), the resulting graph (graph),
match count (matches) and errors encountered (errors).</p>
<p><code>graph</code> is the graph to link (will be modified unless <code>output_graph</code> is defined.</p>
<p><code>target_prop</code> is the property name that is used for saving the link.</p>
<p><code>arpa</code> is the <a href="#arpa.Arpa"><code>Arpa</code></a> class instance.</p>
<p><code>source_prop</code> is the property that's value will be used when querying ARPA (if omitted, skos:prefLabel is used).</p>
<p>If <code>rdf_class</code> is given, only go through instances of this type.</p>
<p><code>output_graph</code> is the graph to which the results should be added. If not given, the results will be added
to the input <code>graph</code>.</p>
<p><code>preprocessor</code> is an optional function that processes the query text before it is used in the ARPA query.
It receives whatever is the value of <code>source_prop</code> for the current subject, the current subject, and the graph.</p>
<p><code>validator</code> is an object with a <code>validate</code> method that takes the ARPA results, query text, and the processed
subject as parameters, and returns a subset of the results (that have been validated based on the subject,
graph and results). Optional.</p>
<p>If <code>candidates_only</code> is set, get candidates (n-grams) only from ARPA.</p>
<p>If <code>progress</code> is <code>True</code>, show a progress bar. Requires pyprind.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.arpafy', this);">Show source &equiv;</a></p>
  <div id="source-arpa.arpafy" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">arpafy</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">target_prop</span><span class="p">,</span> <span class="n">arpa</span><span class="p">,</span> <span class="n">source_prop</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rdf_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">output_graph</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">preprocessor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">candidates_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Link a property to resources using ARPA. Modify the graph in place,</span>
<span class="sd">    unless `output_graph` is given.</span>

<span class="sd">    Return a dict with the amount of processed triples (processed), the resulting graph (graph),</span>
<span class="sd">    match count (matches) and errors encountered (errors).</span>

<span class="sd">    `graph` is the graph to link (will be modified unless `output_graph` is defined.</span>

<span class="sd">    `target_prop` is the property name that is used for saving the link.</span>

<span class="sd">    `arpa` is the `arpa.Arpa` class instance.</span>

<span class="sd">    `source_prop` is the property that&#39;s value will be used when querying ARPA (if omitted, skos:prefLabel is used).</span>

<span class="sd">    If `rdf_class` is given, only go through instances of this type.</span>

<span class="sd">    `output_graph` is the graph to which the results should be added. If not given, the results will be added</span>
<span class="sd">    to the input `graph`.</span>

<span class="sd">    `preprocessor` is an optional function that processes the query text before it is used in the ARPA query.</span>
<span class="sd">    It receives whatever is the value of `source_prop` for the current subject, the current subject, and the graph.</span>

<span class="sd">    `validator` is an object with a `validate` method that takes the ARPA results, query text, and the processed</span>
<span class="sd">    subject as parameters, and returns a subset of the results (that have been validated based on the subject,</span>
<span class="sd">    graph and results). Optional.</span>

<span class="sd">    If `candidates_only` is set, get candidates (n-grams) only from ARPA.</span>

<span class="sd">    If `progress` is `True`, show a progress bar. Requires pyprind.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">source_prop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">source_prop</span> <span class="o">=</span> <span class="n">SKOS</span><span class="p">[</span><span class="s1">&#39;prefLabel&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">output_graph</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">output_graph</span> <span class="o">=</span> <span class="n">graph</span>
    <span class="k">if</span> <span class="n">candidates_only</span><span class="p">:</span>
        <span class="n">get_results</span> <span class="o">=</span> <span class="n">arpa</span><span class="o">.</span><span class="n">get_candidates</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">get_results</span> <span class="o">=</span> <span class="n">arpa</span><span class="o">.</span><span class="n">get_uri_matches</span>

    <span class="n">subgraph</span> <span class="o">=</span> <span class="n">_get_subgraph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="n">rdf_class</span><span class="p">)</span>

    <span class="n">triple_match_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">subject_match_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pre_validation_mention_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">post_validation_mention_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">bar</span> <span class="o">=</span> <span class="n">get_bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="p">),</span> <span class="n">progress</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">subject_objects</span><span class="p">():</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span> <span class="k">if</span> <span class="n">preprocessor</span> <span class="k">else</span> <span class="n">o</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_dict</span> <span class="o">=</span> <span class="n">get_results</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">HTTPError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error getting matches from ARPA&#39;</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span>
            <span class="n">triple_match_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">pre_validation_mention_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pre_validation_mentions&#39;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">subject_match_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">post_validation_mention_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mentions&#39;</span><span class="p">,</span> <span class="p">[]))</span>
                <span class="c1"># Add each result as a value of the target property</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">output_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">target_prop</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;graph&#39;</span><span class="p">:</span> <span class="n">output_graph</span><span class="p">,</span>
        <span class="s1">&#39;processed&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="p">),</span>
        <span class="s1">&#39;matches&#39;</span><span class="p">:</span> <span class="n">triple_match_count</span><span class="p">,</span>
        <span class="s1">&#39;subjects_matched&#39;</span><span class="p">:</span> <span class="n">subject_match_count</span><span class="p">,</span>
        <span class="s1">&#39;pre_validation_mention_count&#39;</span><span class="p">:</span> <span class="n">pre_validation_mention_count</span><span class="p">,</span>
        <span class="s1">&#39;post_validation_mention_count&#39;</span><span class="p">:</span> <span class="n">post_validation_mention_count</span><span class="p">,</span>
        <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">errors</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processed {} triples, found {} matches from {} mentions&#39;</span>
                <span class="s1">&#39; with {} total mentions ({} errors)&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;matches&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;post_validation_mention_count&#39;</span><span class="p">],</span>
                    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;pre_validation_mention_count&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">])))</span>

    <span class="k">return</span> <span class="n">res</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="arpa.combine_candidates">
    <p>def <span class="ident">combine_candidates</span>(</p><p>graph, prop, output_graph=None, rdf_class=None, progress=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Combine each subject's candidates into a single string.</p>
<p>Return the resulting graph.</p>
<p><code>graph</code> is the graph containing the candidates. Will be modified if <code>output_graph</code>
is not given.</p>
<p><code>prop</code> is the URIRef of the property containing the candidates.</p>
<p><code>output_graph</code> is the graph to which the results should be added.
If not given, <code>graph</code> will be modified.</p>
<p>If <code>rdf_class</code> is given, only go through instances of this type.</p>
<p>If <code>progress</code> is set, display a progress bar.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.combine_candidates', this);">Show source &equiv;</a></p>
  <div id="source-arpa.combine_candidates" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">combine_candidates</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">output_graph</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rdf_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine each subject&#39;s candidates into a single string.</span>

<span class="sd">    Return the resulting graph.</span>

<span class="sd">    `graph` is the graph containing the candidates. Will be modified if `output_graph`</span>
<span class="sd">    is not given.</span>

<span class="sd">    `prop` is the URIRef of the property containing the candidates.</span>

<span class="sd">    `output_graph` is the graph to which the results should be added.</span>
<span class="sd">    If not given, `graph` will be modified.</span>

<span class="sd">    If `rdf_class` is given, only go through instances of this type.</span>

<span class="sd">    If `progress` is set, display a progress bar.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">subgraph</span> <span class="o">=</span> <span class="n">_get_subgraph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">rdf_class</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Combining candidates&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_graph</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">output_graph</span> <span class="o">=</span> <span class="n">graph</span>

    <span class="n">subjects</span> <span class="o">=</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">subjects</span><span class="p">()</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">get_bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="p">),</span> <span class="n">progress</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> </span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span>
        <span class="c1"># Remove the original candidate</span>
        <span class="n">output_graph</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="n">output_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">combined</span><span class="p">)))</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Candidates combined succesfully&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_graph</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="arpa.log_to_file">
    <p>def <span class="ident">log_to_file</span>(</p><p>file_name, level)</p>
    </div>
    

    
  
    <div class="desc"><p>Convenience function for setting up logging to file.</p>
<p><code>file_name</code> is the log file name.</p>
<p><code>level</code> is the log level name (string).</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.log_to_file', this);">Show source &equiv;</a></p>
  <div id="source-arpa.log_to_file" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">log_to_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function for setting up logging to file.</span>

<span class="sd">    `file_name` is the log file name.</span>

<span class="sd">    `level` is the log level name (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">level</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="arpa.main">
    <p>def <span class="ident">main</span>(</p><p>args)</p>
    </div>
    

    
  
    <div class="desc"><p>Main function for running via the command line.</p>
<p><code>args</code> is the list of command line arguments.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.main', this);">Show source &equiv;</a></p>
  <div id="source-arpa.main" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function for running via the command line.</span>

<span class="sd">    `args` is the list of command line arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">log_to_file</span><span class="p">(</span><span class="s1">&#39;arpa_linker.log&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

    <span class="n">arpa</span> <span class="o">=</span> <span class="n">Arpa</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">arpa</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">no_duplicates</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">min_ngram</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ignore</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">retries</span><span class="p">)</span>

    <span class="c1"># Query the ARPA service, add the matches and serialize graph to disk</span>
    <span class="n">process</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">fi</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">fo</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">tprop</span><span class="p">,</span> <span class="n">arpa</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">rdf_class</span><span class="p">,</span> <span class="n">new_graph</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">new_graph</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">candidates_only</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">candidates_only</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="arpa.map_results">
    <p>def <span class="ident">map_results</span>(</p><p>results)</p>
    </div>
    

    
  
    <div class="desc"><p>Map general SPARQL results to the format ARPA returns.</p>
<p>Return the mapped results.</p>
<p><code>results</code> is the SPARQL result as a dict. Each row has to include an 'id' variable.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.map_results', this);">Show source &equiv;</a></p>
  <div id="source-arpa.map_results" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">map_results</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map general SPARQL results to the format ARPA returns.</span>

<span class="sd">    Return the mapped results.</span>

<span class="sd">    `results` is the SPARQL result as a dict. Each row has to include an &#39;id&#39; variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Mapping results {} to ARPA format&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;bindings&#39;</span><span class="p">]:</span>
        <span class="n">o_id</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">index</span> <span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">o_id</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">_get_value</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">o</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">o_id</span><span class="p">,</span>
                <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;matches&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ngram&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)],</span>
                <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="n">props</span>
            <span class="p">}</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">ngram</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ngram&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ngram</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;matches&#39;</span><span class="p">]:</span>
                <span class="n">o</span><span class="p">[</span><span class="s1">&#39;matches&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ngram</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_get_value</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">_get_value</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Mapped to: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">res</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="arpa.parse_args">
    <p>def <span class="ident">parse_args</span>(</p><p>args)</p>
    </div>
    

    
  
    <div class="desc"><p>Parse command line arguments. See <a href="#usage">Usage</a> (or the source code) for details.</p>
<p><code>args</code> is the list of command line arguments.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.parse_args', this);">Show source &equiv;</a></p>
  <div id="source-arpa.parse_args" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse command line arguments. See [Usage](#usage) (or the source code) for details.</span>

<span class="sd">    `args` is the list of command line arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">argparser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Link resources to an RDF graph with ARPA.&quot;</span><span class="p">,</span>
            <span class="n">fromfile_prefix_chars</span><span class="o">=</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Input rdf file&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output file&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;tprop&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;target_property&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Target property for the matches&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;arpa&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;ARPA service URL&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--fi&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;INPUT_FORMAT&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Input file format (rdflib parser). Will be guessed if omitted.&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--fo&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;OUTPUT_FORMAT&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output file format (rdflib serializer). Default is turtle.&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;turtle&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="s2">&quot;--new_graph&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Add the ARPA results to a new graph instead of the original. The output file</span>
<span class="s2">        contains all the triples of the original graph by default. With this argument set</span>
<span class="s2">        the output file will contain only the results.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--candidates_only&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Get candidates (n-grams) only from ARPA.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--rdf_class&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;CLASS&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Process only subjects of the given type (goes through all subjects by default).&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--prop&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;PROPERTY&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Property that&#39;s value is to be used in matching. Default is skos:prefLabel.&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ignore&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TERM&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Terms that should be ignored even if matched&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--min_ngram&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The minimum ngram length that is considered a match. Default is 1.&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--no_duplicates&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TYPE&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Remove duplicate matches based on the &#39;label&#39; returned by the ARPA service.</span>
<span class="s2">        Here &#39;duplicate&#39; means a subject with the same label as another subject in</span>
<span class="s2">        the same result set.</span>
<span class="s2">        A list of types can be given with this argument. If given, prioritize matches</span>
<span class="s2">        based on it - the first given type will get the highest priority and so on.</span>
<span class="s2">        Note that the response from the service has to include a &#39;type&#39; variable</span>
<span class="s2">        for this to work.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="s2">&quot;--retries&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The amount of retries per query if a HTTP error is received. Default is 0.&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-w&quot;</span><span class="p">,</span> <span class="s2">&quot;--wait&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The number of seconds to wait between retries. Only has an effect if number</span>
<span class="s2">        of retries is set. Default is 1 second.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--log_level&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;NOTSET&quot;</span><span class="p">,</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">,</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s2">&quot;CRITICAL&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Logging level, default is INFO. The log file is arpa_linker.log.&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">fi</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">fi</span> <span class="o">=</span> <span class="n">guess_format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">prop</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="n">URIRef</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">prop</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">rdf_class</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">rdf_class</span> <span class="o">=</span> <span class="n">URIRef</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">rdf_class</span><span class="p">)</span>

    <span class="n">args</span><span class="o">.</span><span class="n">tprop</span> <span class="o">=</span> <span class="n">URIRef</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tprop</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_duplicates</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_duplicates</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="n">args</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="arpa.post">
    <p>def <span class="ident">post</span>(</p><p>url, data, retries=0, wait=1)</p>
    </div>
    

    
  
    <div class="desc"><p>Send a post request to the given URL with the given data, expecting a JSON response.
Throws a HTTPError if the request fails (after retries, if any) or if JSON
parsing fails.</p>
<p><code>url</code> is the URL to send the request to.</p>
<p><code>data</code> is a dict containing the data to send to the URL.</p>
<p><code>retries</code> is the number of retries to attempt if the request fails. Optional.</p>
<p><code>wait</code> is the number of seconds to wait between retries. Optional, default is 1 second.
Has no effect if <code>retries</code> is not set.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.post', this);">Show source &equiv;</a></p>
  <div id="source-arpa.post" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a post request to the given URL with the given data, expecting a JSON response.</span>
<span class="sd">    Throws a HTTPError if the request fails (after retries, if any) or if JSON</span>
<span class="sd">    parsing fails.</span>

<span class="sd">    `url` is the URL to send the request to.</span>

<span class="sd">    `data` is a dict containing the data to send to the URL.</span>

<span class="sd">    `retries` is the number of retries to attempt if the request fails. Optional.</span>

<span class="sd">    `wait` is the number of seconds to wait between retries. Optional, default is 1 second.</span>
<span class="sd">    Has no effect if `retries` is not set.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid amount of retries: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retries</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">wait</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid retry wait time: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wait</span><span class="p">))</span>

    <span class="n">tries</span> <span class="o">=</span> <span class="n">retries</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">tries</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Sending request to {} with data: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">HTTPError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">tries</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">tries</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Received error ({}) from {} with request data: {}.&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Waiting {} seconds before retrying&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wait</span><span class="p">))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">retries</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Error {}, out of retries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="s1">&#39;Error ({}) from {} with request data: {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Success</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Success, received: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">res</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="arpa.process">
    <p>def <span class="ident">process</span>(</p><p>input_file, input_format, output_file, output_format, *args, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Parse the given input file, run <a href="#arpa.arpafy"><code>arpafy</code></a>, and serialize the resulting
graph on disk.</p>
<p><code>input_file</code> is the name of the rdf file to be parsed.</p>
<p><code>input_format</code> is the input file format.</p>
<p><code>output_file</code> is the output file name.</p>
<p><code>output_format</code> is the output file format.</p>
<p><code>validator_class</code> is class that takes the input graph as parameter, and implements
a <code>validate</code> method. See <a href="#arpa.arpafy"><code>arpafy</code></a> for more information.
This overrides any validator object given as the <a href="#arpa.arpafy"><code>arpafy</code></a> <code>validator</code> parameter.</p>
<p>All other arguments are passed to <a href="#arpa.process_graph"><code>process_graph</code></a>.</p>
<p>Return the results dict as returned by <a href="#arpa.arpafy"><code>arpafy</code></a>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.process', this);">Show source &equiv;</a></p>
  <div id="source-arpa.process" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">input_format</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">output_format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="n">validator_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse the given input file, run `arpa.arpafy`, and serialize the resulting</span>
<span class="sd">    graph on disk.</span>

<span class="sd">    `input_file` is the name of the rdf file to be parsed.</span>

<span class="sd">    `input_format` is the input file format.</span>

<span class="sd">    `output_file` is the output file name.</span>

<span class="sd">    `output_format` is the output file format.</span>

<span class="sd">    `validator_class` is class that takes the input graph as parameter, and implements</span>
<span class="sd">    a `validate` method. See `arpa.arpafy` for more information.</span>
<span class="sd">    This overrides any validator object given as the `arpa.arpafy` `validator` parameter.</span>

<span class="sd">    All other arguments are passed to `arpa.process_graph`.</span>

<span class="sd">    Return the results dict as returned by `arpa.arpafy`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Parsing file {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_file</span><span class="p">))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">input_format</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Parsing complete&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">validator_class</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;validator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">validator_class</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">process_graph</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">output_graph</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Serializing graph as {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">))</span>
    <span class="n">output_graph</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">destination</span><span class="o">=</span><span class="n">output_file</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">output_format</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Serialization complete&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="arpa.process_graph">
    <p>def <span class="ident">process_graph</span>(</p><p>graph, *args, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Convenience function for running different tasks related to linking.</p>
<p><code>graph</code> is the graph to be processed.</p>
<p>If <code>new_graph</code> is set, use a new empty graph for adding the results.</p>
<p>If <code>prune</code> is set, prune candidates using <a href="#arpa.prune_candidates"><code>prune_candidates</code></a>.</p>
<p>If <code>join_candidates</code> is set, combine candidates into a single value using
<a href="#arpa.combine_candidates"><code>combine_candidates</code></a>.</p>
<p>Setting <code>run_arpafy</code> to False will skip running <a href="#arpa.arpafy"><code>arpafy</code></a>.
Useful with <code>join_candidates</code>.</p>
<p><code>source_prop</code> is the property URI that contains the values to be processed.</p>
<p>For <code>pruner</code> see <a href="#arpa.prune_candidates"><code>prune_candidates</code></a>.</p>
<p>If <code>progress</code> is <code>True</code>, show a progress bar. Requires pyprind.</p>
<p>All other arguments are passed to <a href="#arpa.arpafy"><code>arpafy</code></a> (if run).</p>
<p>Return the results dict as returned by <a href="#arpa.arpafy"><code>arpafy</code></a>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.process_graph', this);">Show source &equiv;</a></p>
  <div id="source-arpa.process_graph" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">process_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">new_graph</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">prune</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">join_candidates</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">run_arpafy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">source_prop</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rdf_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pruner</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function for running different tasks related to linking.</span>

<span class="sd">    `graph` is the graph to be processed.</span>

<span class="sd">    If `new_graph` is set, use a new empty graph for adding the results.</span>

<span class="sd">    If `prune` is set, prune candidates using `arpa.prune_candidates`.</span>

<span class="sd">    If `join_candidates` is set, combine candidates into a single value using</span>
<span class="sd">    `arpa.combine_candidates`.</span>

<span class="sd">    Setting `run_arpafy` to False will skip running `arpa.arpafy`.</span>
<span class="sd">    Useful with `join_candidates`.</span>

<span class="sd">    `source_prop` is the property URI that contains the values to be processed.</span>

<span class="sd">    For `pruner` see `arpa.prune_candidates`.</span>

<span class="sd">    If `progress` is `True`, show a progress bar. Requires pyprind.</span>

<span class="sd">    All other arguments are passed to `arpa.arpafy` (if run).</span>

<span class="sd">    Return the results dict as returned by `arpa.arpafy`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">new_graph</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Output to new graph&#39;</span><span class="p">)</span>
        <span class="n">output_graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
        <span class="n">output_graph</span><span class="o">.</span><span class="n">namespace_manager</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">namespace_manager</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_graph</span> <span class="o">=</span> <span class="n">graph</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Begin processing&#39;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">prune</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Prune candidates&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">prune_candidates</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="n">pruner</span><span class="p">,</span>
                <span class="n">rdf_class</span><span class="o">=</span><span class="n">rdf_class</span><span class="p">,</span> <span class="n">output_graph</span><span class="o">=</span><span class="n">output_graph</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">join_candidates</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Combine candidates&#39;</span><span class="p">)</span>
        <span class="n">output_graph</span> <span class="o">=</span> <span class="n">combine_candidates</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span>
                <span class="n">output_graph</span><span class="o">=</span><span class="n">output_graph</span><span class="p">,</span> <span class="n">rdf_class</span><span class="o">=</span><span class="n">rdf_class</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">output_graph</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;graph&#39;</span><span class="p">:</span> <span class="n">output_graph</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">run_arpafy</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Start arpafy&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">arpafy</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">source_prop</span><span class="o">=</span><span class="n">source_prop</span><span class="p">,</span> <span class="n">rdf_class</span><span class="o">=</span><span class="n">rdf_class</span><span class="p">,</span>
                <span class="n">output_graph</span><span class="o">=</span><span class="n">output_graph</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing complete, runtime {}&#39;</span><span class="o">.</span>
            <span class="n">format</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">res</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="arpa.prune_candidates">
    <p>def <span class="ident">prune_candidates</span>(</p><p>graph, source_prop, pruner, rdf_class=None, output_graph=None, progress=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Prune undesired candidates.</p>
<p>Return a dict with the amount of candidates left after pruning (result_count),
and the resulting graph (graph).</p>
<p><code>graph</code> is the graph containing the candidates. Will be modified if <code>output_graph</code>
is not given.</p>
<p><code>source_prop</code> is the property in the graph that has the candidates as its value.</p>
<p><code>pruner</code> is a function that receives a single candidate as string and returns
a falsey value if the candidate should not be added to the output graph, and
otherwise a string (the candidate, possibly modified) that should be added
to the output graph.</p>
<p>If <code>rdf_class</code> is given, only go through instances of this type.</p>
<p><code>output_graph</code> is the graph to which the results should be added.
If not given, the results will be added to the input <code>graph</code>,
and the old candidates removed.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.prune_candidates', this);">Show source &equiv;</a></p>
  <div id="source-arpa.prune_candidates" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">prune_candidates</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="n">pruner</span><span class="p">,</span> <span class="n">rdf_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">output_graph</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prune undesired candidates.</span>

<span class="sd">    Return a dict with the amount of candidates left after pruning (result_count),</span>
<span class="sd">    and the resulting graph (graph).</span>

<span class="sd">    `graph` is the graph containing the candidates. Will be modified if `output_graph`</span>
<span class="sd">    is not given.</span>

<span class="sd">    `source_prop` is the property in the graph that has the candidates as its value.</span>

<span class="sd">    `pruner` is a function that receives a single candidate as string and returns</span>
<span class="sd">    a falsey value if the candidate should not be added to the output graph, and</span>
<span class="sd">    otherwise a string (the candidate, possibly modified) that should be added</span>
<span class="sd">    to the output graph.</span>

<span class="sd">    If `rdf_class` is given, only go through instances of this type.</span>

<span class="sd">    `output_graph` is the graph to which the results should be added.</span>
<span class="sd">    If not given, the results will be added to the input `graph`,</span>
<span class="sd">    and the old candidates removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Pruning candidates&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_graph</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">output_graph</span> <span class="o">=</span> <span class="n">graph</span>

    <span class="n">subgraph</span> <span class="o">=</span> <span class="n">_get_subgraph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="n">rdf_class</span><span class="p">)</span>

    <span class="n">bar</span> <span class="o">=</span> <span class="n">get_bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="p">),</span> <span class="n">progress</span><span class="p">)</span>

    <span class="n">result_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">subject_objects</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pruner</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
        <span class="c1"># Remove the original candidate</span>
        <span class="n">output_graph</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Add the pruned candidate to the output graph</span>
            <span class="n">output_graph</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">source_prop</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;graph&#39;</span><span class="p">:</span> <span class="n">output_graph</span><span class="p">,</span>
        <span class="s1">&#39;result_count&#39;</span><span class="p">:</span> <span class="n">result_count</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Candidate pruning complete&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>
</pre></div>

  </div>
</div>

  </div>
  

    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="arpa.Arpa" class="name">class <span class="ident">Arpa</span></p>
      
  
    <div class="desc"><p>Class representing the ARPA service</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.Arpa', this);">Show source &equiv;</a></p>
  <div id="source-arpa.Arpa" class="source">
    <div class="codehilite"><pre><span class="k">class</span> <span class="nc">Arpa</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class representing the ARPA service&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">remove_duplicates</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">min_ngram_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">retries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wait_between_tries</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Arpa service object.</span>

<span class="sd">        `url` is the ARPA service url.</span>

<span class="sd">        If `remove_duplicates` is `True`, choose only one subject out of all the</span>
<span class="sd">        matched subjects that have the same label (arbitrarily).</span>
<span class="sd">        If, instead, the value is a list or a tuple, assume that it represents</span>
<span class="sd">        a list of class names and prefer those classes when choosing</span>
<span class="sd">        the subject. The ARPA results must include a property (`arpa.TYPE_PROP`)</span>
<span class="sd">        that has the class of the match as the value. Optional.</span>

<span class="sd">        `min_ngram_length` is the minimum ngram match length that will be included when</span>
<span class="sd">        returning the query results. Optional.</span>

<span class="sd">        `ignore` is a list of matches that should be removed from the results (case insensitive).</span>
<span class="sd">        Optional.</span>

<span class="sd">        `retries` is the number of retries per query. Optional.</span>

<span class="sd">        `wait_between_tries` is the amount of times in seconds to wait between retries.</span>
<span class="sd">        Optional, default is 1 second. Has no effect if `retries` is not set.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Initialize Arpa instance&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Number of retries has to be a non-negative number, got {}&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retries</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">wait_between_tries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Retry wait time has to be a non-negative number, got {}&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wait_between_tries</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_retries</span> <span class="o">=</span> <span class="n">retries</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ignore</span> <span class="ow">or</span> <span class="p">[]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_ngram_length</span> <span class="o">=</span> <span class="n">min_ngram_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">=</span> <span class="n">wait_between_tries</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">remove_duplicates</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span> <span class="o">=</span> <span class="n">remove_duplicates</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;&lt;{}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">remove_duplicates</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA ignore set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA url set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA min_ngram_length set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_ngram_length</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA no_duplicates set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA retries set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_retries</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_remove_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove duplicates from the entries.</span>

<span class="sd">        A &#39;duplicate&#39; is an entry with the same `LABEL_PROP` property value.</span>

<span class="sd">        If `self._no_duplicates == True`, choose the subject to keep any which way.</span>

<span class="sd">        If `self._no_duplicates` is a tuple (or a list), choose the kept subject</span>
<span class="sd">        by comparing its type to the types contained in the tuple. The lower the</span>
<span class="sd">        index of the type in the tuple, the higher the priority.</span>

<span class="sd">        `entries` is the ARPA service results as a JSON object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">entries</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">add</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">add</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">LABEL_PROP</span><span class="p">]</span> <span class="ow">in</span> <span class="n">labels</span>
                <span class="c1"># If the label is not in the labels set, add it to the set.</span>
                <span class="c1"># This works because set.add() returns None.</span>
                <span class="ow">or</span> <span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">LABEL_PROP</span><span class="p">]))]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span><span class="p">:</span>
            <span class="c1"># self._no_duplicates is a tuple - prioritize types defined in it</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">LABEL_PROP</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="c1"># Get the types of the latest most preferrable entry that</span>
                <span class="c1"># had the same label as this one</span>
                <span class="n">prev_match_types</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x_label</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TYPE_PROP</span><span class="p">,</span> <span class="p">[])</span>
                <span class="c1"># Get matches from the preferred types for the previously selected entry</span>
                <span class="n">prev_pref</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">prev_match_types</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Find the priority of the previously selected entry</span>
                    <span class="n">prev_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">prev_pref</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># No previous entry or previous entry doesn&#39;t have a preferred type</span>
                    <span class="n">prev_idx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                <span class="c1"># Get matches in the preferred types for this entry</span>
                <span class="n">pref</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="n">TYPE_PROP</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">pref</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># This one is not of a preferred type</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">prev_match_types</span><span class="p">)</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">prev_idx</span><span class="p">:</span>
                    <span class="c1"># There is no previous entry with this label or</span>
                    <span class="c1"># the current match has a higher priority preferred type</span>
                    <span class="n">items</span><span class="p">[</span><span class="n">x_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>

            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_filter_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">get_len</span><span class="p">,</span> <span class="n">get_label</span><span class="p">,</span> <span class="n">skip_remove_duplicates</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal filter function used by `arpa.Arpa._filter`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Filter ignored results</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">get_label</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span><span class="p">]</span>

        <span class="c1"># Filter by minimum ngram length</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_ngram_length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">get_len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_ngram_length</span><span class="p">]</span>

        <span class="c1"># Remove duplicates unless requested to skip</span>
        <span class="k">if</span> <span class="n">skip_remove_duplicates</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_duplicates</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">candidates</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter matches based on `self._ignore` and remove matches that are</span>
<span class="sd">        for ngrams with length less than `self.min_ngram_length`.</span>

<span class="sd">        Return the response with the ignored matches removed.</span>

<span class="sd">        `results` is the parsed ARPA service results.</span>

<span class="sd">        `candidates` is whether or not the results contain just the candidates.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Filtering candidates&#39;</span><span class="p">)</span>
            <span class="n">get_len</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="n">get_label</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="c1"># No use in removing literal duplicates</span>
            <span class="n">skip_remove_duplicates</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Filtering results&#39;</span><span class="p">)</span>
            <span class="n">get_len</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;ngram&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="n">get_label</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">LABEL_PROP</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">skip_remove_duplicates</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">get_len</span><span class="p">,</span> <span class="n">get_label</span><span class="p">,</span> <span class="n">skip_remove_duplicates</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sanitize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="c1"># Remove quotation marks and brackets - ARPA can return an error if they&#39;re present</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">text</span>
        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">candidates</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the ARPA service and return the response results as JSON</span>

<span class="sd">        Results will be filtered if a filter was specified at init.</span>

<span class="sd">        `text` is the text used in the query.</span>

<span class="sd">        If `candidates` is set, query for candidates only.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Query ARPA at {} with text {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>

        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Empty ARPA query text&#39;</span><span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;?cgen&#39;</span> <span class="k">if</span> <span class="n">candidates</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Query the ARPA service with the text</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_retries</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_wait</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">candidates</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_uris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the URIs from results.</span>

<span class="sd">        `results` is the results as returned by `arpa.query`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">URIRef</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_distinct_mentions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get distinct mentions (i.e. matches) that yielded results.</span>

<span class="sd">        `results` is the results as returned by `arpa.query`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">m</span> <span class="k">for</span> <span class="n">ml</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;matches&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ml</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_uri_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query ARPA and return a dict with a list of uris of resources that match the text.</span>

<span class="sd">        Return a dict where &#39;results&#39; has the list of uris, &#39;mentions&#39; has the mentions</span>
<span class="sd">        that yielded results, and &#39;pre_validation_mentions&#39; has mentions that yielded</span>
<span class="sd">        results before running the `validator`.</span>

<span class="sd">        `text` is the text to use in the query.</span>

<span class="sd">        `validator` is an object that implements a `validate` method that takes</span>
<span class="sd">        the results and `text` (and any other parameters passed to this method)</span>
<span class="sd">        as parameters, and returns a subset of the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting URI matches: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="n">pre_validation_mentions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">post_validation_mentions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">validator</span> <span class="ow">and</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Validating results: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
            <span class="n">pre_validation_mentions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distinct_mentions</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Distinct mentions before validation: {} ({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pre_validation_mentions</span><span class="p">),</span> <span class="n">pre_validation_mentions</span><span class="p">))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found matches {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
            <span class="n">post_validation_mentions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distinct_mentions</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Distinct mentions: {} ({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">post_validation_mentions</span><span class="p">),</span> <span class="n">post_validation_mentions</span><span class="p">))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_uris</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No matches found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="s1">&#39;mentions&#39;</span><span class="p">:</span> <span class="n">post_validation_mentions</span><span class="p">,</span>
            <span class="s1">&#39;pre_validation_mentions&#39;</span><span class="p">:</span> <span class="n">pre_validation_mentions</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the candidates from `text` that would be used by the ARPA service</span>
<span class="sd">        to query for matches.</span>

<span class="sd">        A dict is returned for compatibility with `arpa.get_uri_matches`.</span>

<span class="sd">        Return a dict where &#39;results&#39; has the candidates as a list of rdflib Literals.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Empty ARPA query text&#39;</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">candidates</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Received candidates: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Literal</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span> <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]}</span>

        <span class="k">return</span> <span class="n">result</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#arpa.Arpa">Arpa</a></li>
          <li>builtins.object</li>
          </ul>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="arpa.Arpa.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, url, remove_duplicates=False, min_ngram_length=1, ignore=None, retries=0, wait_between_tries=1)</p>
    </div>
    

    
  
    <div class="desc"><p>Initialize the Arpa service object.</p>
<p><code>url</code> is the ARPA service url.</p>
<p>If <code>remove_duplicates</code> is <code>True</code>, choose only one subject out of all the
matched subjects that have the same label (arbitrarily).
If, instead, the value is a list or a tuple, assume that it represents
a list of class names and prefer those classes when choosing
the subject. The ARPA results must include a property (<a href="#arpa.TYPE_PROP"><code>TYPE_PROP</code></a>)
that has the class of the match as the value. Optional.</p>
<p><code>min_ngram_length</code> is the minimum ngram match length that will be included when
returning the query results. Optional.</p>
<p><code>ignore</code> is a list of matches that should be removed from the results (case insensitive).
Optional.</p>
<p><code>retries</code> is the number of retries per query. Optional.</p>
<p><code>wait_between_tries</code> is the amount of times in seconds to wait between retries.
Optional, default is 1 second. Has no effect if <code>retries</code> is not set.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.Arpa.__init__', this);">Show source &equiv;</a></p>
  <div id="source-arpa.Arpa.__init__" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">remove_duplicates</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">min_ngram_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">retries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wait_between_tries</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the Arpa service object.</span>
<span class="sd">    `url` is the ARPA service url.</span>
<span class="sd">    If `remove_duplicates` is `True`, choose only one subject out of all the</span>
<span class="sd">    matched subjects that have the same label (arbitrarily).</span>
<span class="sd">    If, instead, the value is a list or a tuple, assume that it represents</span>
<span class="sd">    a list of class names and prefer those classes when choosing</span>
<span class="sd">    the subject. The ARPA results must include a property (`arpa.TYPE_PROP`)</span>
<span class="sd">    that has the class of the match as the value. Optional.</span>
<span class="sd">    `min_ngram_length` is the minimum ngram match length that will be included when</span>
<span class="sd">    returning the query results. Optional.</span>
<span class="sd">    `ignore` is a list of matches that should be removed from the results (case insensitive).</span>
<span class="sd">    Optional.</span>
<span class="sd">    `retries` is the number of retries per query. Optional.</span>
<span class="sd">    `wait_between_tries` is the amount of times in seconds to wait between retries.</span>
<span class="sd">    Optional, default is 1 second. Has no effect if `retries` is not set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Initialize Arpa instance&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Number of retries has to be a non-negative number, got {}&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retries</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">wait_between_tries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Retry wait time has to be a non-negative number, got {}&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wait_between_tries</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_retries</span> <span class="o">=</span> <span class="n">retries</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">url</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ignore</span> <span class="ow">or</span> <span class="p">[]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_min_ngram_length</span> <span class="o">=</span> <span class="n">min_ngram_length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span> <span class="o">=</span> <span class="n">wait_between_tries</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">remove_duplicates</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span> <span class="o">=</span> <span class="n">remove_duplicates</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;&lt;{}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">remove_duplicates</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA ignore set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA url set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA min_ngram_length set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_ngram_length</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA no_duplicates set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_no_duplicates</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ARPA retries set to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_retries</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="arpa.Arpa.extract_uris">
    <p>def <span class="ident">extract_uris</span>(</p><p>self, results)</p>
    </div>
    

    
  
    <div class="desc"><p>Get the URIs from results.</p>
<p><code>results</code> is the results as returned by <code>arpa.query</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.Arpa.extract_uris', this);">Show source &equiv;</a></p>
  <div id="source-arpa.Arpa.extract_uris" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">extract_uris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the URIs from results.</span>
<span class="sd">    `results` is the results as returned by `arpa.query`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">URIRef</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="arpa.Arpa.get_candidates">
    <p>def <span class="ident">get_candidates</span>(</p><p>self, text, *args, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Get the candidates from <code>text</code> that would be used by the ARPA service
to query for matches.</p>
<p>A dict is returned for compatibility with <code>arpa.get_uri_matches</code>.</p>
<p>Return a dict where 'results' has the candidates as a list of rdflib Literals.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.Arpa.get_candidates', this);">Show source &equiv;</a></p>
  <div id="source-arpa.Arpa.get_candidates" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">get_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the candidates from `text` that would be used by the ARPA service</span>
<span class="sd">    to query for matches.</span>
<span class="sd">    A dict is returned for compatibility with `arpa.get_uri_matches`.</span>
<span class="sd">    Return a dict where &#39;results&#39; has the candidates as a list of rdflib Literals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Empty ARPA query text&#39;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">candidates</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Received candidates: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Literal</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span> <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]}</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="arpa.Arpa.get_distinct_mentions">
    <p>def <span class="ident">get_distinct_mentions</span>(</p><p>self, results)</p>
    </div>
    

    
  
    <div class="desc"><p>Get distinct mentions (i.e. matches) that yielded results.</p>
<p><code>results</code> is the results as returned by <code>arpa.query</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.Arpa.get_distinct_mentions', this);">Show source &equiv;</a></p>
  <div id="source-arpa.Arpa.get_distinct_mentions" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">get_distinct_mentions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get distinct mentions (i.e. matches) that yielded results.</span>
<span class="sd">    `results` is the results as returned by `arpa.query`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">m</span> <span class="k">for</span> <span class="n">ml</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;matches&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ml</span><span class="p">}</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="arpa.Arpa.get_uri_matches">
    <p>def <span class="ident">get_uri_matches</span>(</p><p>self, text, *args, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Query ARPA and return a dict with a list of uris of resources that match the text.</p>
<p>Return a dict where 'results' has the list of uris, 'mentions' has the mentions
that yielded results, and 'pre_validation_mentions' has mentions that yielded
results before running the <code>validator</code>.</p>
<p><code>text</code> is the text to use in the query.</p>
<p><code>validator</code> is an object that implements a <code>validate</code> method that takes
the results and <code>text</code> (and any other parameters passed to this method)
as parameters, and returns a subset of the results.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.Arpa.get_uri_matches', this);">Show source &equiv;</a></p>
  <div id="source-arpa.Arpa.get_uri_matches" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">get_uri_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query ARPA and return a dict with a list of uris of resources that match the text.</span>
<span class="sd">    Return a dict where &#39;results&#39; has the list of uris, &#39;mentions&#39; has the mentions</span>
<span class="sd">    that yielded results, and &#39;pre_validation_mentions&#39; has mentions that yielded</span>
<span class="sd">    results before running the `validator`.</span>
<span class="sd">    `text` is the text to use in the query.</span>
<span class="sd">    `validator` is an object that implements a `validate` method that takes</span>
<span class="sd">    the results and `text` (and any other parameters passed to this method)</span>
<span class="sd">    as parameters, and returns a subset of the results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting URI matches: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">pre_validation_mentions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">post_validation_mentions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">validator</span> <span class="ow">and</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Validating results: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
        <span class="n">pre_validation_mentions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distinct_mentions</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Distinct mentions before validation: {} ({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pre_validation_mentions</span><span class="p">),</span> <span class="n">pre_validation_mentions</span><span class="p">))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found matches {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
        <span class="n">post_validation_mentions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distinct_mentions</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Distinct mentions: {} ({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">post_validation_mentions</span><span class="p">),</span> <span class="n">post_validation_mentions</span><span class="p">))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_uris</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No matches found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
        <span class="s1">&#39;mentions&#39;</span><span class="p">:</span> <span class="n">post_validation_mentions</span><span class="p">,</span>
        <span class="s1">&#39;pre_validation_mentions&#39;</span><span class="p">:</span> <span class="n">pre_validation_mentions</span>
    <span class="p">}</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="arpa.Arpa.query">
    <p>def <span class="ident">query</span>(</p><p>self, text, candidates=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Query the ARPA service and return the response results as JSON</p>
<p>Results will be filtered if a filter was specified at init.</p>
<p><code>text</code> is the text used in the query.</p>
<p>If <code>candidates</code> is set, query for candidates only.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.Arpa.query', this);">Show source &equiv;</a></p>
  <div id="source-arpa.Arpa.query" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">candidates</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query the ARPA service and return the response results as JSON</span>
<span class="sd">    Results will be filtered if a filter was specified at init.</span>
<span class="sd">    `text` is the text used in the query.</span>
<span class="sd">    If `candidates` is set, query for candidates only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Query ARPA at {} with text {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Empty ARPA query text&#39;</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;?cgen&#39;</span> <span class="k">if</span> <span class="n">candidates</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># Query the ARPA service with the text</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_retries</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_wait</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">candidates</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="arpa.ArpaMimic" class="name">class <span class="ident">ArpaMimic</span></p>
      
  
    <div class="desc"><p>Class that behaves like <a href="#arpa.Arpa"><code>Arpa</code></a> except that it queries a SPARQL endpoint
instead of an ARPA service.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.ArpaMimic', this);">Show source &equiv;</a></p>
  <div id="source-arpa.ArpaMimic" class="source">
    <div class="codehilite"><pre><span class="k">class</span> <span class="nc">ArpaMimic</span><span class="p">(</span><span class="n">Arpa</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that behaves like `arpa.Arpa` except that it queries a SPARQL endpoint</span>
<span class="sd">    instead of an ARPA service.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_template</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the ArpaMimic instance.</span>

<span class="sd">        `query_template` is a SPARQL query template like ARPA uses.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">query_template</span> <span class="o">=</span> <span class="n">query_template</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">url_params</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query a SPARQL endpoint and return the response results as JSON mapped</span>
<span class="sd">        as if returned by ARPA.</span>

<span class="sd">        `text` is the text used in the query.</span>

<span class="sd">        `url_params` is any URL parameters to be added to the URL.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Querying {} with text {} using ArpaMimic&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Empty query text&#39;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;VALUES&gt;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">+</span> <span class="n">url_params</span>

        <span class="c1"># Query the endpoint with the text</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_retries</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_wait</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">map_results</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">[]))</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#arpa.ArpaMimic">ArpaMimic</a></li>
          <li><a href="#arpa.Arpa">Arpa</a></li>
          <li>builtins.object</li>
          </ul>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="arpa.ArpaMimic.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, query_template, *args, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Initialize the ArpaMimic instance.</p>
<p><code>query_template</code> is a SPARQL query template like ARPA uses.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.ArpaMimic.__init__', this);">Show source &equiv;</a></p>
  <div id="source-arpa.ArpaMimic.__init__" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_template</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the ArpaMimic instance.</span>
<span class="sd">    `query_template` is a SPARQL query template like ARPA uses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">query_template</span> <span class="o">=</span> <span class="n">query_template</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="arpa.ArpaMimic.extract_uris">
    <p>def <span class="ident">extract_uris</span>(</p><p>self, results)</p>
    </div>
    

    
  
    <div class="desc"><p>Get the URIs from results.</p>
<p><code>results</code> is the results as returned by <code>arpa.query</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.ArpaMimic.extract_uris', this);">Show source &equiv;</a></p>
  <div id="source-arpa.ArpaMimic.extract_uris" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">extract_uris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the URIs from results.</span>
<span class="sd">    `results` is the results as returned by `arpa.query`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">URIRef</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="arpa.ArpaMimic.get_candidates">
    <p>def <span class="ident">get_candidates</span>(</p><p>self, text, *args, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Get the candidates from <code>text</code> that would be used by the ARPA service
to query for matches.</p>
<p>A dict is returned for compatibility with <code>arpa.get_uri_matches</code>.</p>
<p>Return a dict where 'results' has the candidates as a list of rdflib Literals.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.ArpaMimic.get_candidates', this);">Show source &equiv;</a></p>
  <div id="source-arpa.ArpaMimic.get_candidates" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">get_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the candidates from `text` that would be used by the ARPA service</span>
<span class="sd">    to query for matches.</span>
<span class="sd">    A dict is returned for compatibility with `arpa.get_uri_matches`.</span>
<span class="sd">    Return a dict where &#39;results&#39; has the candidates as a list of rdflib Literals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Empty ARPA query text&#39;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">candidates</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Received candidates: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Literal</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span> <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]}</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="arpa.ArpaMimic.get_distinct_mentions">
    <p>def <span class="ident">get_distinct_mentions</span>(</p><p>self, results)</p>
    </div>
    

    
  
    <div class="desc"><p>Get distinct mentions (i.e. matches) that yielded results.</p>
<p><code>results</code> is the results as returned by <code>arpa.query</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.ArpaMimic.get_distinct_mentions', this);">Show source &equiv;</a></p>
  <div id="source-arpa.ArpaMimic.get_distinct_mentions" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">get_distinct_mentions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get distinct mentions (i.e. matches) that yielded results.</span>
<span class="sd">    `results` is the results as returned by `arpa.query`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">m</span> <span class="k">for</span> <span class="n">ml</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;matches&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ml</span><span class="p">}</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="arpa.ArpaMimic.get_uri_matches">
    <p>def <span class="ident">get_uri_matches</span>(</p><p>self, text, *args, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Query ARPA and return a dict with a list of uris of resources that match the text.</p>
<p>Return a dict where 'results' has the list of uris, 'mentions' has the mentions
that yielded results, and 'pre_validation_mentions' has mentions that yielded
results before running the <code>validator</code>.</p>
<p><code>text</code> is the text to use in the query.</p>
<p><code>validator</code> is an object that implements a <code>validate</code> method that takes
the results and <code>text</code> (and any other parameters passed to this method)
as parameters, and returns a subset of the results.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.ArpaMimic.get_uri_matches', this);">Show source &equiv;</a></p>
  <div id="source-arpa.ArpaMimic.get_uri_matches" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">get_uri_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query ARPA and return a dict with a list of uris of resources that match the text.</span>
<span class="sd">    Return a dict where &#39;results&#39; has the list of uris, &#39;mentions&#39; has the mentions</span>
<span class="sd">    that yielded results, and &#39;pre_validation_mentions&#39; has mentions that yielded</span>
<span class="sd">    results before running the `validator`.</span>
<span class="sd">    `text` is the text to use in the query.</span>
<span class="sd">    `validator` is an object that implements a `validate` method that takes</span>
<span class="sd">    the results and `text` (and any other parameters passed to this method)</span>
<span class="sd">    as parameters, and returns a subset of the results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting URI matches: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">pre_validation_mentions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">post_validation_mentions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">validator</span> <span class="ow">and</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Validating results: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
        <span class="n">pre_validation_mentions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distinct_mentions</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Distinct mentions before validation: {} ({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pre_validation_mentions</span><span class="p">),</span> <span class="n">pre_validation_mentions</span><span class="p">))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found matches {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
        <span class="n">post_validation_mentions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distinct_mentions</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Distinct mentions: {} ({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">post_validation_mentions</span><span class="p">),</span> <span class="n">post_validation_mentions</span><span class="p">))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_uris</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No matches found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
        <span class="s1">&#39;mentions&#39;</span><span class="p">:</span> <span class="n">post_validation_mentions</span><span class="p">,</span>
        <span class="s1">&#39;pre_validation_mentions&#39;</span><span class="p">:</span> <span class="n">pre_validation_mentions</span>
    <span class="p">}</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="arpa.ArpaMimic.query">
    <p>def <span class="ident">query</span>(</p><p>self, text, url_params=&#39;&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Query a SPARQL endpoint and return the response results as JSON mapped
as if returned by ARPA.</p>
<p><code>text</code> is the text used in the query.</p>
<p><code>url_params</code> is any URL parameters to be added to the URL.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-arpa.ArpaMimic.query', this);">Show source &equiv;</a></p>
  <div id="source-arpa.ArpaMimic.query" class="source">
    <div class="codehilite"><pre><span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">url_params</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query a SPARQL endpoint and return the response results as JSON mapped</span>
<span class="sd">    as if returned by ARPA.</span>
<span class="sd">    `text` is the text used in the query.</span>
<span class="sd">    `url_params` is any URL parameters to be added to the URL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Querying {} with text {} using ArpaMimic&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Empty query text&#39;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;VALUES&gt;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">+</span> <span class="n">url_params</span>
    <span class="c1"># Query the endpoint with the text</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_retries</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_wait</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">map_results</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="p">[]))</span>
</pre></div>

  </div>
</div>

  </div>
  
          <h3>Instance variables</h3>
            <div class="item">
            <p id="arpa.ArpaMimic.query_template" class="name">var <span class="ident">query_template</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
